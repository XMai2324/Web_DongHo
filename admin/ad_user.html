<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin_Management</title>

  <!-- Font Awesome (gi·ªëng admin.html) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- CSS d√πng chung t·ª´ trang admin -->
  <!-- ‚ö†Ô∏è ch·ªânh l·∫°i ƒë∆∞·ªùng d·∫´n n·∫øu c·∫•u tr√∫c th∆∞ m·ª•c kh√°c -->
  <link rel="stylesheet" href="../admin/ad_css/admin.css" />
  <!-- <script src="../view/js/auth.js"></script> -->

  <!-- (tu·ª≥ ch·ªçn) favicon/logo n·∫øu c√≥ -->
  <!-- <link rel="icon" type="image/png" href="/view/image/logo.png"> -->

  <style>
    /* ·∫®n header c≈© n·∫øu trang b·∫°n c√≥, tr√°nh x√¥ l·ªách layout khi d√πng sidebar c·ªë ƒë·ªãnh */
   
    /* v√πng n·ªôi dung ch√≠nh c√≥ kho·∫£ng ƒë·ªám ƒë·∫πp h∆°n trong layout m·ªõi */
    .tab-container{
      width: min(1200px, 100% - 48px);
      margin: 24px auto 20px;
    }

    /* M·ªôt s·ªë l·ªõp s·∫µn c√≥ trong giao di·ªán ng∆∞·ªùi d√πng g·ªëc:
       N·∫øu b·∫°n ƒë√£ c√≥ CSS ri√™ng th√¨ c√≥ th·ªÉ b·ªè b·ªõt. Ch·ªß y·∫øu ƒë·ªÉ b·∫£ng/btn tr√¥ng ·ªïn. */
    .tab-buttons{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab-btn{
      border:1px solid #e5e7eb; background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    .tab-btn.active{ background:#111827; color:#fff; }
    .tab-content{ margin-top:16px; }
    .user-table{ width:100%; border-collapse: collapse; background:#fff; border-radius:14px; overflow:hidden; }
    .user-table th, .user-table td{ border-bottom:1px solid #e5e7eb; padding:10px 12px; text-align:left; }
    .user-table thead th{ background:#f3f4f6; font-weight:600; }
    .btn{ border:1px solid #e5e7eb; background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .management-header, .control-panel{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:12px 0; }
    .search-box{ display:flex; gap:6px; align-items:center; }
    .search-box input{ height:36px; padding:0 10px; border:1px solid #e5e7eb; border-radius:10px; min-width:260px; }
    .hello{ margin: 8px 0 16px; font-size: 16px; color: #111827; }
    /* B·∫£o ƒë·∫£m v√πng n·ªôi dung kh√¥ng b·ªã d√≠nh s√°t c·∫°nh */
    .main-content { padding: 16px; }
  </style>
</head>

<body>
    <div class="admin-container">
    <!-- ========== SIDEBAR (copy t·ª´ admin) ========== -->
        <aside class="sidebar">
        <div class="logo">
            <!-- ‚ö†Ô∏è s·ª≠a ƒë∆∞·ªùng d·∫´n ·∫£nh logo n·∫øu kh√°c -->
            <img src="/view/image/logo2.png" alt="Logo" />
        </div>
        <h2 class="hello">Qu·∫£n tr·ªã vi√™n</h2>

        <ul class="menu">
            <li class="menu-title"><a href="admin.html">S·∫£n ph·∫©m</a></li>
            <ul class="submenu" id="leftMenu">
            <li data-entity="watch" class="is-active">ƒê·ªìng h·ªì</li>
            <li data-entity="strap">D√¢y ƒëeo</li>
            <li data-entity="box">H·ªôp ƒë·ª±ng</li>
            <li data-entity="glass">K√≠nh c∆∞·ªùng l·ª±c</li>
            </ul>

            <li class="menu-title">ƒê∆°n h√†ng</li>
            <li class="menu-title"><a href="../admin/ad_user.html">Kh√°ch h√†ng</a></li>
            <li class="menu-title"><a href="../admin/nhaphang.html">Nh·∫≠p h√†ng</a></li>

            <li>
            <div class="actions">
                <div class="account">
                <i class="fa-regular fa-user"></i>
                <span>Admin</span>
                </div>
                <div class="logout" id="logoutBtn" title="ƒêƒÉng xu·∫•t">
                <i class="fa-solid fa-right-from-bracket"></i>
                </div>
            </div>
            </li>
        </ul>
        </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="main-content">
      <div class="tab-container">
        <!-- Tabs -->
        <div class="tab-buttons">
          <button class="tab-btn active" data-target="qluser" id="tabUserBtn">Qu·∫£n l√Ω Ng∆∞·ªùi D√πng</button>
          <button class="tab-btn" data-target="qlgiabanloinhuan" id="tabPriceProfitBtn">Qu·∫£n l√Ω Gi√° B√°n &amp; L·ª£i Nhu·∫≠n</button>
        </div>

        <div class="tab-content">
          <!-- ==== TAB: Qu·∫£n l√Ω Ng∆∞·ªùi D√πng ==== -->
          <div id="qluser" class="tab-pane" style="">
            <h2>Qu·∫£n l√Ω Danh s√°ch Ng∆∞·ªùi D√πng</h2>

            <div class="management-header">
              <h3>T·ªïng s·ªë ng∆∞·ªùi d√πng: <span id="userCount">0</span></h3>
              <button class="btn btn-add" id="openAddModal" style="background-color: #5db9e4;;">+ Th√™m Ng∆∞·ªùi D√πng M·ªõi</button>
            </div>

            <table class="user-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>M·∫≠t kh·∫©u</th>
                  <th>Vai tr√≤</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <!-- JS s·∫Ω render danh s√°ch ng∆∞·ªùi d√πng v√†o ƒë√¢y -->
              </tbody>
            </table>
          </div>

          <!-- ==== TAB: Qu·∫£n l√Ω Gi√° B√°n & L·ª£i Nhu·∫≠n ==== -->
          <div id="qlgiabanloinhuan" class="tab-pane" style="display:none;">
            <h2>Qu·∫£n l√Ω Gi√° B√°n v√† L·ª£i Nhu·∫≠n</h2>

            <div class="control-panel">
              <div class="search-box">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo T√™n SP, M√£ SP..." />
                <button class="btn" id="btnSearch" title="T√¨m ki·∫øm">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>

              <div style="display:flex; gap:10px;">
                <button class="btn primary" id="btnAddProduct">+ Th√™m S·∫£n Ph·∫©m M·ªõi</button>
                <button class="btn" id="btnProfitSetting">C·∫≠p Nh·∫≠t T·ªâ L·ªá</button>
              </div>
            </div>

            <table class="user-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>T√™n s·∫£n ph·∫©m</th>
                  <th>Th∆∞∆°ng hi·ªáu / Chi ti·∫øt PK</th>
                  <th>Size</th>
                  <th>Gi√° v·ªën (VNƒê)</th>
                  <th>T·ªâ l·ªá l·ª£i nhu·∫≠n</th>
                  <th>Gi√° b√°n (VNƒê)</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <!-- JS s·∫Ω render danh s√°ch s·∫£n ph·∫©m v√†o ƒë√¢y -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      </div> 
            <div id="addModal" class="modal">
            <div class="modal-content">
                <span class="close-btn add-close-btn">&times;</span>
                <h3 id="addModalTitle">Th√™m Ng∆∞·ªùi D√πng M·ªõi</h3>
                <form id="addUserForm">
                    <label for="addUsername">Username</label>
                    <input type="text" id="addUsername" required>

                    <label for="addEmail">Email</label>
                    <input type="email" id="addEmail" required>

                    <label for="addPassword">M·∫≠t kh·∫©u</label>
                    <input type="password" id="addPassword" required>

                    <label for="addRole">Vai tr√≤</label>
                    <select id="addRole">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>

                    <button type="submit" class="btn btn-add">Th√™m Ng∆∞·ªùi D√πng</button>
                </form>
            </div>
        </div>
            


        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-btn edit-close-btn">&times;</span>
                <h3 id="editModalTitle">Ch·ªânh S·ª≠a Ng∆∞·ªùi D√πng</h3>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId"> 
                    
                    <label for="editUsername">Username</label>
                    <input type="text" id="editUsername" required readonly>
                    
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" required readonly>
                    <label for="editPassword">Password</label>

                    <div class="input-row-reset" style="height: 50px;"> 
                        <input type="password" id="editPassword" required readonly placeholder="******" style="width: 80%;">
                        <button type="button" id="resetPasswordBtn" class="btn btn-reset" style="width: 20%; margin: 10px 10px 20px 10px; padding: 5px">Reset</button>
                    </div>
                    
                    <label for="editRole" style="display: none;" >Vai tr√≤</label>
                    <select id="editRole" style="display: none;">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" id="disableUserBtn" class="btn btn-disable" style="flex: 1; background-color: #ff4d4f;">V√¥ hi·ªáu h√≥a</button>
                        <button type="button" id="enableUserBtn" class="btn btn-enable" style="flex: 1; background-color: #52c41a;">M·ªü ho·∫°t ƒë·ªông</button>
                    </div>
                </form>
            </div>
        </div>

            <div id="productModal" class="modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeProductModal()">&times;</span>
                    <h2 id="productModalTitle">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <div class="form-group">
                            <label for="productName">T√™n S·∫£n Ph·∫©m</label>
                            <input type="text" id="productName" required>
                        </div>

                        <div class="form-group">
                            <label for="productType">Th∆∞∆°ng hi·ªáu</label>
                           <select id="productType" required>
                                    <option value="" disabled selected>Ch·ªçn Lo·∫°i S·∫£n Ph·∫©m</option>
                                    <option value="Rolex">Rolex</option>
                                    <option value="Citizen">Citizen</option>
                                    <option value="Casio">Casio</option>
                                    <option value="Seiko">Seiko</option>
                                    <option value="Rado">Rado</option>
                                    <option value="Ph·ª• ki·ªán">Ph·ª• ki·ªán</option>
                                    <option value="H·ªôp ƒë·ª±ng">H·ªôp ƒë·ª±ng</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="sizeGroup">
                            <label for="productSize">K√≠ch c·ª°/ƒê·ªëi t∆∞·ª£ng</label>
                            <select id="productSize">
                                <option value="N/A" selected>Kh√¥ng √°p d·ª•ng</option>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                                <option value="C·∫∑p ƒë√¥i">C·∫∑p ƒë√¥i</option>
                            </select>
                            <small class="form-text text-muted">Ch·ªâ √°p d·ª•ng cho ƒê·ªìng h·ªì.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="productCostPrice">Gi√° V·ªën (VND)</label>
                            <input type="number" id="productCostPrice" min="0" step="1000" required>
                        </div>

                        <div class="form-group">
                            <label for="productProfitPercent">T·ªâ l·ªá L·ª£i Nhu·∫≠n Ri√™ng (%)</label>
                            <input type="number" id="productProfitPercent" min="0" max="100" step="1" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ √°p d·ª•ng t·ªâ l·ªá chung" >
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="closeProductModal()">H·ªßy</button>
                            <button type="submit" class="btn-primary">L∆∞u S·∫£n Ph·∫©m</button>
                        </div>
                    </form>
                </div>
            </div>

    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <span class="close-btn" onclick="closeDeleteConfirmation()">&times;</span>
            <h2>X√°c nh·∫≠n X√≥a S·∫£n Ph·∫©m</h2>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m: "<span id="productToDeleteName" style="font-weight: bold; color: #dc3545;"></span>" kh√¥ng?</p>
            
            <input type="hidden" id="productToDeleteId" value=""> 

            <div class="btn-group">
                <button class="btn-secondary" onclick="closeDeleteConfirmation()" style="margin-top: 17px;">H·ªßy</button>
                <button class="btn btn-danger" onclick="confirmDelete()">X√°c nh·∫≠n X√≥a</button>
            </div>
        </div>
    </div>

    <div id="profitSettingsModal" class="modal">
            <div class="modal-content">
            <span class="modal-close" onclick="closeProfitSettingsModal()">&times;</span>
            <h2>C·∫≠p Nh·∫≠t T·ªâ L·ªá L·ª£i Nhu·∫≠n Chung</h2> 
            <form id="profitSettingsForm">
                <div id="profitSettingsContainer">
                </div>
                <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="closeProfitSettingsModal() " style="margin-top:20px;">H·ªßy B·ªè</button>
                <button type="submit" class="btn-primary" style="margin-top: 20px;">L∆∞u C√†i ƒê·∫∑t</button> 
                </div>
            </form>
        </div>
        </div>

    <template id="profitInputTemplate">
        <div class="form-group input-group">
            <label data-label-id="label-text" for="margin-type">T·ªâ l·ªá L·ª£i Nhu·∫≠n {{labelText}} (%):</label>
            <input 
                type="number" 
                data-input-id="margin-input"
                data-type="{{type}}" 
                value="0" 
                min="0" 
                max="100" 
                step="1" 
                required
            >
        </div>
    </template>
    </main>    
    </div>

    <!-- S·∫£n ph·∫©m -->
    <script src="ad_js/data.js"></script>
 <script>

    const SUPERADMIN_ID = 99999;
    
    // --- KH·ªûI T·∫†O V√Ä KI·ªÇM TRA QUY·ªÄN TRUY C·∫¨P ---
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'admin') {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã. Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n Admin.');
        window.location.href = 'login.html';
    }

    // --- C√ÅC PH·∫¶N T·ª¨ DOM ---
    const userTableBody = document.getElementById('userTableBody');
    const userCountElement = document.getElementById('userCount');
    
    // DOM cho Tabs
    const tabUserBtn = document.getElementById('tabUserBtn');
    const tabPriceProfitBtn = document.getElementById('tabPriceProfitBtn');

    // DOM cho Modal Th√™m/S·ª≠a Ng∆∞·ªùi d√πng
    const addModal = document.getElementById('addModal');
    const addUserForm = document.getElementById('addUserForm');
    const addCloseBtn = document.querySelector('.add-close-btn');
    const openAddModalBtn = document.getElementById('openAddModal'); 
    const editModal = document.getElementById('editModal');
    const editUserForm = document.getElementById('editUserForm');
    const editCloseBtn = document.querySelector('.edit-close-btn');

    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const disableUserBtn = document.getElementById('disableUserBtn');
    const enableUserBtn = document.getElementById('enableUserBtn');
    
    // DOM cho tab QL Gi√° B√°n & L·ª£i Nhu·∫≠n
    const productTableBody = document.getElementById('productTableBody');
    const productModal = document.getElementById('productModal');
    const productForm = document.getElementById('productForm');
    const productModalTitle = document.getElementById('productModalTitle');
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const profitInputTemplate = document.getElementById('profitInputTemplate');
    const profitSettingsModal = document.getElementById('profitSettingsModal');
    const profitSettingsForm = document.getElementById('profitSettingsForm');
    const profitSettingsContainer = document.getElementById('profitSettingsContainer');
    const searchInput = document.getElementById('searchInput');
    const profitRateForm = document.getElementById('profitRateForm');
    const profitRateInput = document.getElementById('newGlobalProfitRate');
    const profitRateModal = document.getElementById('profitRateModal');
    
    // DOM cho Product Modal fields m·ªõi
    const productType = document.getElementById('productType');
    const productSize = document.getElementById('productSize');

    // --- LOGIC ·∫®N/HI·ªÜN DIV (TAB) M·ªöI ---
    function showTab(targetId) {
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.style.display = 'none';
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.style.display = 'block';
        }

        const activeButton = document.querySelector(`.tab-btn[data-target="${targetId}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // T·∫£i d·ªØ li·ªáu t√πy theo tab ƒë∆∞·ª£c ch·ªçn (ƒê√£ s·ª≠a l·ªói kh√¥ng t·∫£i s·∫£n ph·∫©m)
        if (targetId === 'qluser') {
            loadUsers();
        } else if (targetId === 'qlgiabanloinhuan') { 
            loadProducts(); // <--- CH·∫ÆC CH·∫ÆN G·ªåI H√ÄM T·∫¢I D·ªÆ LI·ªÜU S·∫¢N PH·∫®M
        }
    }

    // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t tab
    tabUserBtn.onclick = () => showTab('qluser');
    tabPriceProfitBtn.onclick = () => showTab('qlgiabanloinhuan');
    
    // --- 1. CH·ª®C NƒÇNG T·∫¢I & HI·ªÇN TH·ªä D·ªÆ LI·ªÜU USER (READ) ---
    function loadUsers() {
        let users = JSON.parse(localStorage.getItem('accounts')) || [];
        
        userTableBody.innerHTML = '';
        userCountElement.textContent = users.length;
        
        users.forEach(user => {
            let actionsHTML = ''; 
            if (user.id === SUPERADMIN_ID) { 
                actionsHTML = '<span style="color:#dc3545; font-weight: 500;">üö´ ƒê√£ kh√≥a</span>';
            } else {
                actionsHTML = `
                    <button class="actions-btn btn-edit" data-id="${user.id}">S·ª≠a</button>
                    <button class="actions-btn btn-delete" data-id="${user.id}">X√≥a</button>
                `;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td><span style="color:#555;font-style:italic;">(ƒê√£ ·∫©n)</span></td>
                <td>${user.role}</td>
                <td>
                    <span style="color: ${user.status === 'disabled' ? '#dc3545' : '#28a745'}; font-weight: bold;">
                        ${user.status === 'disabled' ? 'V√¥ hi·ªáu h√≥a' : 'Ho·∫°t ƒë·ªông'}
                    </span>
                </td>
                <td>
                    ${actionsHTML}
                </td>
            `;
            userTableBody.appendChild(row);
        });
        
        attachEventListeners();
    }
    
    // --- 2. X·ª¨ L√ù S·ª∞ KI·ªÜN T·ª™ C√ÅC N√öT H√ÄNH ƒê·ªòNG (EDIT & DELETE) ---
    function attachEventListeners() {
        // S·ª± ki·ªán S·ª≠a
        document.querySelectorAll('.btn-edit').forEach(button => {
            button.onclick = (e) => openEditModal(parseInt(e.target.dataset.id));
        });

        // S·ª± ki·ªán X√≥a
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.onclick = (e) => deleteUser(parseInt(e.target.dataset.id));
        });
        
        // S·ª± ki·ªán ƒêƒÉng xu·∫•t
        logoutBtn.onclick = () => {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        };
    }
    
    // --- 3. CH·ª®C NƒÇNG TH√äM/S·ª¨A USER (CREATE & UPDATE) ---
    
    // 3.1. ƒê√≥ng/M·ªü Modal
    openAddModalBtn.onclick = () => {
        addUserForm.reset(); 
        addModal.style.display = 'block';
    };
    
    addCloseBtn.onclick = () => addModal.style.display = 'none';
    editCloseBtn.onclick = () => editModal.style.display = 'none';
    
    // 3.2. M·ªü Modal S·ª≠a 
    function openEditModal(userId) {

        if (userId === SUPERADMIN_ID) { 
            alert('B·∫°n kh√¥ng th·ªÉ ch·ªânh s·ª≠a th√¥ng tin t√†i kho·∫£n Super Admin.'); 
            return;
        }

        editUserForm.reset();
        const users = JSON.parse(localStorage.getItem('accounts'));
        const user = users.find(u => u.id === userId);
        
        if (user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role; 
            
            const isUserDisabled = user.status === 'disabled';
            disableUserBtn.style.display = isUserDisabled ? 'none' : 'block';
            enableUserBtn.style.display = isUserDisabled ? 'block' : 'none';

            editModal.style.display = 'block';
        }
    }

    // 3.3. X·ª≠ l√Ω Th√™m Ng∆∞·ªùi D√πng (Submit Form Th√™m)
    addUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('addUsername').value.trim();
        const email = document.getElementById('addEmail').value.trim();
        const password = document.getElementById('addPassword').value.trim();
        const role = document.getElementById('addRole').value;
        
        let users = JSON.parse(localStorage.getItem('accounts')) || [];
        
        // Ch·∫ø ƒë·ªô Th√™m (Create)
        const newUser = { 
            id: Date.now(), 
            username, 
            email, 
            password, 
            role,
            status: 'active'
        };
        users.push(newUser);

        localStorage.setItem('accounts', JSON.stringify(users));
        addModal.style.display = 'none';
        loadUsers(); 
    });

    // 3.4. X·ª≠ l√Ω S·ª≠a Ng∆∞·ªùi D√πng (Submit Form S·ª≠a)
    editUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const id = parseInt(document.getElementById('editUserId').value);
        const newrole = document.getElementById('editRole').value; 

        if (id === SUPERADMIN_ID) { 
            alert('L·ªói: Kh√¥ng th·ªÉ thay ƒë·ªïi vai tr√≤ c·ªßa t√†i kho·∫£n Super Admin.'); 
            editModal.style.display = 'none';
            return;
        }
        
        let users = JSON.parse(localStorage.getItem('acounts')) || [];
        
        const index = users.findIndex(u => u.id === id);
        
        if (index !== -1) {
            let updatedUser = {
                id: id,
                username: users[index].username, 
                email: users[index].email,       
                password: users[index].password,
                role: newrole,
                status: users[index].status || 'active'
            };
            users[index] = updatedUser;

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (currentUser && currentUser.id === id) {
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                
                if (newrole === 'acounts') {
                    alert('Vai tr√≤ c·ªßa b·∫°n ƒë√£ b·ªã thay ƒë·ªïi th√†nh User. B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß/ƒëƒÉng nh·∫≠p.');
                    window.location.href = 'login.html'; 
                }
            }
        }

        localStorage.setItem('accounts', JSON.stringify(users));
        editModal.style.display = 'none';
        loadUsers(); 
    });
        
    // --- 4. CH·ª®C NƒÇNG X√ìA USER (DELETE) ---
    function deleteUser(userId) {

        if (userId === SUPERADMIN_ID) { 
            alert('L·ªói: Kh√¥ng ƒë∆∞·ª£c ph√©p x√≥a t√†i kho·∫£n Super Admin.'); 
            return;
        } 	

        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng ID ${userId} kh√¥ng?`)) {
            let users = JSON.parse(localStorage.getItem('accounts')) || [];
            
            users = users.filter(u => u.id !== userId);
            
            localStorage.setItem('accounts', JSON.stringify(users));
            loadUsers(); 
        }
    }

    // --- CH·ª®C NƒÇNG RESET M·∫¨T KH·∫®U (ADMIN) ---
    function resetPassword(userId) {

        if (userId === SUPERADMIN_ID) { 
            alert('L·ªói: Kh√¥ng ƒë∆∞·ª£c ph√©p reset m·∫≠t kh·∫©u c·ªßa t√†i kho·∫£n Super Admin.'); 
            return;
        }

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën RESET m·∫≠t kh·∫©u cho ng∆∞·ªùi d√πng ID ${userId} v·ªÅ '123456' kh√¥ng?`)) {
            return; 
        }

        let users = JSON.parse(localStorage.getItem('accounts')) || [];
        const index = users.findIndex(u => u.id === userId);

        if (index !== -1) {
            let updatedUser = {
                ...users[index], 
                password: '123456' 
            };
            users[index] = updatedUser;

            localStorage.setItem('accounts', JSON.stringify(users));

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.id === userId) {
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
            }

            alert(`ƒê√£ reset m·∫≠t kh·∫©u th√†nh c√¥ng cho ID ${userId}. M·∫≠t kh·∫©u m·ªõi: 123456`);
            editModal.style.display = 'none';
            loadUsers(); 
        } else {
            alert("L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ reset m·∫≠t kh·∫©u.");
        }
    }

    resetPasswordBtn.onclick = function() {
        const userId = parseInt(document.getElementById('editUserId').value);
        if (userId) {
            resetPassword(userId);
        }
    };

    if (disableUserBtn && enableUserBtn) {
        disableUserBtn.onclick = function() {
            const userId = parseInt(document.getElementById('editUserId').value);
            if (userId) {
                changeUserStatus(userId, 'disabled');
            }
        };

        enableUserBtn.onclick = function() {
            const userId = parseInt(document.getElementById('editUserId').value);
            if (userId) {
                changeUserStatus(userId, 'active');
            }
        };
    }

    function changeUserStatus(userId, newStatus) {

        if (userId === SUPERADMIN_ID) { 
            alert('L·ªói: Kh√¥ng ƒë∆∞·ª£c ph√©p thay ƒë·ªïi tr·∫°ng th√°i c·ªßa t√†i kho·∫£n Super Admin.'); 
            return;
        }

        let users = JSON.parse(localStorage.getItem('accounts')) || [];
        const index = users.findIndex(u => u.id === userId);
        
        const action = newStatus === 'disabled' ? 'v√¥ hi·ªáu h√≥a' : 'm·ªü ho·∫°t ƒë·ªông';

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} ng∆∞·ªùi d√πng ID ${userId} kh√¥ng?`)) {
            return;
        }

        if (index !== -1) {
            let updatedUser = {
                ...users[index], 
                status: newStatus 
            };
            users[index] = updatedUser;

            localStorage.setItem('accounts', JSON.stringify(users));

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.id === userId) {
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                if (newStatus === 'disabled') {
                    alert('T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã v√¥ hi·ªáu h√≥a. B·∫°n s·∫Ω ƒë∆∞·ª£c ƒëƒÉng xu·∫•t.');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                    return;
                }
            }

            alert(`ƒê√£ ${action} th√†nh c√¥ng ng∆∞·ªùi d√πng ID ${userId}.`);
            editModal.style.display = 'none';
            loadUsers(); 
        } else {
            alert("L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.");
        }
    } 	


    

   // --- H√ÄM T√çNH TO√ÅN GI√Å B√ÅN (B·∫ÆT BU·ªòC) ---
function calculateSalePrice(costPrice, profitPercent) {
    if (costPrice === undefined || isNaN(costPrice) || costPrice <= 0) {
        return 0; // Tr√°nh l·ªói chia cho 0 ho·∫∑c gi√° v·ªën kh√¥ng h·ª£p l·ªá
    }
    if (profitPercent === undefined || profitPercent === null || isNaN(profitPercent)) {
        return costPrice; // N·∫øu kh√¥ng c√≥ profit %, gi√° b√°n b·∫±ng gi√° v·ªën
    }
    // T√≠nh to√°n v√† l√†m tr√≤n gi√° b√°n
    return Math.round(costPrice * (1 + profitPercent / 100));
}

    function formatCurrency(amount) {
        if (amount === undefined || amount === null) return 'N/A';
        return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    // --- LOGIC QU·∫¢N L√ù T·ªà L·ªÜ L·ª¢I NHU·∫¨N CHUNG (MARGINS) ---
function getProductMargins() {
    const defaultMargins = {
        'M·∫∑c ƒë·ªãnh': 35, 
        'ƒê·ªìng h·ªì': 30,    
        'Ph·ª• ki·ªán': 40
    };
    const savedMargins = JSON.parse(localStorage.getItem('profit_margins'));
    return savedMargins ? { ...defaultMargins, ...savedMargins } : defaultMargins;
}
// --- H√ÄM T·∫†O DYNAMIC INPUTS (ƒê√£ s·ª≠a ƒë·ªÉ ch·ªâ c√≤n 3 lo·∫°i) ---
// --- H√ÄM T·∫†O DYNAMIC INPUTS (ƒê√£ s·ª≠a ƒë·ªÉ ch·ªâ c√≤n 3 lo·∫°i) ---
function renderProfitInputs(margins) {
    const container = document.getElementById('profitSettingsContainer');
    const template = document.getElementById('profitInputTemplate');
    if (!container || !template) return;

    container.innerHTML = '';
    
    const categories = [
        'ƒê·ªìng h·ªì', 
        'Ph·ª• ki·ªán', 
        'M·∫∑c ƒë·ªãnh' 
    ];

    categories.forEach(category => {
        const clone = template.content.cloneNode(true);
        const labelText = clone.querySelector('[data-label-id="label-text"]');
        const input = clone.querySelector('[data-input-id="margin-input"]');

        labelText.textContent = `T·ªâ l·ªá L·ª£i Nhu·∫≠n ${category} (%):`;
        input.setAttribute('data-category', category); 
        input.value = margins[category] !== undefined ? margins[category] : ''; 
        input.removeAttribute('required'); 
        input.removeAttribute('data-input-id');
        input.removeAttribute('data-type');

        container.appendChild(clone);
    });
}   

// --- H√ÄM M·ªû MODAL (Kh√¥ng ƒë·ªïi, ch·ªâ g·ªçi renderInputs m·ªõi) ---
function openProfitSettingsModal() {
    const margins = getProductMargins();
    renderProfitInputs(margins);
    document.getElementById('profitSettingsModal').style.display = 'block';
}
/**
 * L∆∞u c√°c t·ªâ l·ªá l·ª£i nhu·∫≠n ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a t·ª´ Modal v√†o Local Storage
 * v√† t·∫£i l·∫°i trang ƒë·ªÉ √°p d·ª•ng t·ªâ l·ªá m·ªõi.
 */
window.saveProfitSettings = function() {
    // ƒê·∫£m b·∫£o c√°c ID sau t·ªìn t·∫°i: profitSettingsContainer v√† profitSettingsModal
    const profitSettingsContainer = document.getElementById('profitSettingsContainer');
    const profitSettingsModal = document.getElementById('profitSettingsModal');
    
    if (!profitSettingsContainer || !profitSettingsModal) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ Modal c√†i ƒë·∫∑t l·ª£i nhu·∫≠n c·∫ßn thi·∫øt.');
        return;
    }
    
    const inputElements = profitSettingsContainer.querySelectorAll('input');
    const newMargins = {};

    // 1. Thu th·∫≠p t·∫•t c·∫£ c√°c gi√° tr·ªã t·ªâ l·ªá m·ªõi
    inputElements.forEach(input => {
        const type = input.dataset.type; // L·∫•y lo·∫°i s·∫£n ph·∫©m (Rolex, Casio, M·∫∑c ƒë·ªãnh...)
        let value = parseFloat(input.value);
        
        if (isNaN(value) || value < 0) {
            value = 0;
        } else if (value > 100) { 
            value = 100;
        }
        
        newMargins[type] = value;
    });

    // 2. L∆∞u tr·ªØ ƒë·ªëi t∆∞·ª£ng t·ªâ l·ªá m·ªõi v√†o Local Storage
    localStorage.setItem('profit_margins', JSON.stringify(newMargins));
    
    // 3. Th√¥ng b√°o v√† ƒë√≥ng Modal
    alert('ƒê√£ c·∫≠p nh·∫≠t t·ªâ l·ªá l·ª£i nhu·∫≠n th√†nh c√¥ng! D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c t√≠nh to√°n l·∫°i.');
    profitSettingsModal.style.display = 'none';
    
    // 4. √ÅP D·ª§NG: Bu·ªôc t·∫£i l·∫°i s·∫£n ph·∫©m ƒë·ªÉ √°p d·ª•ng t·ªâ l·ªá m·ªõi
    // Vi·ªác n√†y k√≠ch ho·∫°t l·∫°i h√†m transformProductsFromDataJS v·ªõi t·ªâ l·ªá l·ª£i nhu·∫≠n m·ªõi.
    localStorage.removeItem('products'); 
    window.location.reload(); 
};

    function saveProductMargins(margins) {
        localStorage.setItem('productMargins', JSON.stringify(margins));
    }



    // --- LOGIC T·∫¢I S·∫¢N PH·∫®M & HI·ªÇN TH·ªä (PRODUCT READ) ---
  // --- LOGIC T·∫¢I S·∫¢N PH·∫®M & FORMAT D·ªÆ LI·ªÜU ---
// --- LOGIC T·∫¢I S·∫¢N PH·∫®M & FORMAT D·ªÆ LI·ªÜU ---
// --- LOGIC T·∫¢I S·∫¢N PH·∫®M & FORMAT D·ªÆ LI·ªÜU ---
function getProducts() {
    let products = JSON.parse(localStorage.getItem('products')) || [];

    // Logic l·ªçc tr√πng l·∫∑p (Gi·ªØ nguy√™n)
    const uniqueProducts = [];
    const productIds = new Set(); 
    for (const p of products) {
        if (!productIds.has(p.id)) {
            productIds.add(p.id);
            uniqueProducts.push(p);
        }
    }
    products = uniqueProducts;

    const margins = getProductMargins();

    return products.map(p => {
        const productCategoryName = p.categoryName || 'M·∫∑c ƒë·ªãnh'; 
        
        // ‚≠êÔ∏è FIX: S·ª≠ d·ª•ng tr∆∞·ªùng 'type' ('ƒê·ªìng h·ªì'/'Ph·ª• ki·ªán') ƒë·ªÉ tra c·ª©u margin
        // N·∫øu kh√¥ng c√≥ type, d√πng 'M·∫∑c ƒë·ªãnh'
        const typeForMarginLookup = p.type || 'M·∫∑c ƒë·ªãnh';
        
        let profit = p.profitPercent;
        
        // Ch·ªâ t√≠nh l·∫°i profit n·∫øu ng∆∞·ªùi d√πng KH√îNG ƒë·∫∑t % ri√™ng cho s·∫£n ph·∫©m n√†y
        if (profit === undefined || profit === null || profit === '') {
            profit = margins[typeForMarginLookup] !== undefined 
                     ? margins[typeForMarginLookup] 
                     : margins['M·∫∑c ƒë·ªãnh'];
        }
        
        // Chu·∫©n h√≥a size
        let finalSize = p.size;
        if (!finalSize || finalSize.toString().toUpperCase().trim() === 'N/A' || finalSize.toString().trim() === '') {
            finalSize = 'Kh√¥ng';
        }
        
        const salePrice = calculateSalePrice(p.costPrice, profit);
        
        return {
            ...p,
            categoryName: productCategoryName,
            profitPercent: profit,
            salePrice: salePrice,
            size: finalSize
        };
    });
}

 function loadProducts(searchTerm = '', productType = 'T·∫•t c·∫£') {
    let products = getProducts();
    productTableBody.innerHTML = '';

    const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
    
    // Logic l·ªçc s·∫£n ph·∫©m (Gi·ªØ nguy√™n)
    if (productType !== 'T·∫•t c·∫£') {
        products = products.filter(p => p.type === productType);
    }
    if (lowerCaseSearchTerm) {
        products = products.filter(p => 
            p.name.toLowerCase().includes(lowerCaseSearchTerm) ||
            p.id.toString().includes(lowerCaseSearchTerm)
        );
    }

    if (products.length === 0) {
        productTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</td></tr>`;
        return;
    }

    products.forEach(p => {
        const row = document.createElement('tr');
        // ‚≠êÔ∏è S·ª¨A: L·∫•y gi√° tr·ªã size (ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a th√†nh 'Kh√¥ng' trong getProducts)
        const sizeValue = p.size; 
        
        row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td style="font-weight: bold;">${p.categoryName}</td> <td>${sizeValue}</td> 
            <td>${formatCurrency(p.costPrice)}</td>
            <td style=" color: ${p.profitPercent > 25 ? '#198754' : '#0d6efd'}; font-weight: bold;">
                ${p.profitPercent}% 
            </td>
            <td style=" font-weight: bold;">${formatCurrency(p.salePrice)}</td>
            <td style="display: flex;">
                <button class="actions-btn btn-edit product-actions-btn" onclick="openProductModal(${p.id})">S·ª≠a</button>
                <button class="actions-btn btn-delete product-actions-btn" onclick="openDeleteConfirmation(${p.id}, '${p.name.replace(/'/g, "\\'")}')">X√≥a</button>
            </td>
        `;
        productTableBody.appendChild(row); 
    });
}

    // --- CH·ª®C NƒÇNG T√åM KI·∫æM ---
    function searchProducts() {
        const term = searchInput.value;
        loadProducts(term);
    }
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProducts();
        }
    });

    // --- CH·ª®C NƒÇNG MODAL TH√äM/S·ª¨A S·∫¢N PH·∫®M (CREATE/UPDATE) ---

   window.openProductModal = function(productId = null) {
    productForm.reset();
    document.getElementById('productId').value = '';
    document.getElementById('productProfitPercent').value = ''; 
    document.getElementById('productType').value = ''; 
    // ‚≠êÔ∏è S·ª¨A: Reset v·ªÅ chu·ªói r·ªóng trong input (ng∆∞·ªùi d√πng s·∫Ω nh·∫≠p size)
    document.getElementById('productSize').value = ''; 

    if (productId === null) {
        productModalTitle.textContent = 'Th√™m S·∫£n Ph·∫©m M·ªõi';
    } else {
        productModalTitle.textContent = 'Ch·ªânh S·ª≠a S·∫£n Ph·∫©m';
        const products = getProducts();
        const product = products.find(p => p.id === productId);

        if (product) {
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productType').value = product.categoryName; 
            // ‚≠êÔ∏è S·ª¨A: Hi·ªÉn th·ªã size th·ª±c t·∫ø (ho·∫∑c chu·ªói r·ªóng n·∫øu gi√° tr·ªã l√† 'Kh√¥ng')
            document.getElementById('productSize').value = product.size === 'Kh√¥ng' ? '' : product.size; 
            document.getElementById('productCostPrice').value = product.costPrice;
            
            let actualProducts = JSON.parse(localStorage.getItem('products')) || [];
            const actualProduct = actualProducts.find(p => p.id === productId);

            if (actualProduct && actualProduct.profitPercent !== undefined) {
                document.getElementById('productProfitPercent').value = actualProduct.profitPercent;
            } else {
                document.getElementById('productProfitPercent').placeholder = `ƒê·ªÉ tr·ªëng ƒë·ªÉ √°p d·ª•ng t·ªâ l·ªá chung (${product.profitPercent}%)`;
            }
        }
    }
    productModal.style.display = 'block';
}


// H√†m ƒë√≥ng Modal (ƒë·∫£m b·∫£o h√†m n√†y ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a)
function closeProfitSettingsModal() {
    document.getElementById('profitSettingsModal').style.display = 'none';
}



    window.closeProductModal = function() {
        productModal.style.display = 'none';
    }

   productForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const id = document.getElementById('productId').value;
    const name = document.getElementById('productName').value.trim();
    
    // ‚≠êÔ∏è FIX: ƒê·∫£m b·∫£o categoryName lu√¥n c√≥ gi√° tr·ªã (Issue 2)
    let specificCategoryName = document.getElementById('productType').value.trim() || 'M·∫∑c ƒë·ªãnh'; 
    
    const size = document.getElementById('productSize').value;
    const costPrice = parseFloat(document.getElementById('productCostPrice').value);
    
    const profitPercentInput = document.getElementById('productProfitPercent').value.trim();
    let profitPercent = undefined;

    if (profitPercentInput !== '') {
        const parsedProfit = parseFloat(profitPercentInput);
        if (!isNaN(parsedProfit)) {
            profitPercent = parsedProfit;
        }
    }
    
    let products = JSON.parse(localStorage.getItem('products')) || [];

    // Danh s√°ch Brand/Type ƒë·ªÉ x√°c ƒë·ªãnh Lo·∫°i Chung (genericType)
    const WATCH_BRANDS = ['Rolex', 'Citizen', 'Casio', 'Seiko', 'Rado', 'C·∫∑p ƒë√¥i', 'ƒê·ªìng h·ªì', 'M·∫∑c ƒë·ªãnh'];
    const ACCESSORIES = ['Ph·ª• ki·ªán', 'D√¢y ƒëeo', 'H·ªôp ƒë·ª±ng', 'C∆∞·ªùng l·ª±c'];
    
    // Logic x√°c ƒë·ªãnh l·∫°i Lo·∫°i Chung ('ƒê·ªìng h·ªì'/'Ph·ª• ki·ªán')
    let genericType = 'M·∫∑c ƒë·ªãnh';
    if (WATCH_BRANDS.includes(specificCategoryName)) {
        genericType = 'ƒê·ªìng h·ªì';
    } else if (ACCESSORIES.includes(specificCategoryName)) {
        genericType = 'Ph·ª• ki·ªán';
    } else {
        // N·∫øu l√† lo·∫°i t√πy ch·ªânh (custom brand)
        if (id) {
            // N·∫øu l√† S·ª¨A v√† kh√¥ng kh·ªõp brand, gi·ªØ nguy√™n genericType c≈©
            const index = products.findIndex(p => p.id === parseInt(id));
            if (index !== -1) {
                genericType = products[index].type;
            }
        } else {
            genericType = 'M·∫∑c ƒë·ªãnh'; // S·∫£n ph·∫©m m·ªõi
        }
    }


    if (id) {
        // C·∫≠p nh·∫≠t s·∫£n ph·∫©m hi·ªán c√≥
        const index = products.findIndex(p => p.id === parseInt(id));
        if (index !== -1) {
            products[index] = {
                ...products[index],
                name,
                type: genericType, 
                categoryName: specificCategoryName, // L∆ØU T√äN C·ª§ TH·ªÇ
                size, 
                costPrice,
                profitPercent: profitPercent
            };
        }
        alert('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!');
    } else {
        // Th√™m s·∫£n ph·∫©m m·ªõi
        const newProduct = {
            id: Date.now(),
            name,
            type: genericType, 
            categoryName: specificCategoryName, // L∆ØU T√äN C·ª§ TH·ªÇ
            size, 
            costPrice,
            profitPercent: profitPercent
        };
        products.push(newProduct);
        alert('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');
    }

    localStorage.setItem('products', JSON.stringify(products));
    closeProductModal();
    loadProducts(); 
});


    // --- CH·ª®C NƒÇNG X√ìA S·∫¢N PH·∫®M (DELETE) ---

    window.openDeleteConfirmation = function(productId, productName) {
        document.getElementById('productToDeleteId').value = productId;
        document.getElementById('productToDeleteName').textContent = productName;
        deleteConfirmationModal.style.display = 'block';
    }

    window.closeDeleteConfirmation = function() {
        deleteConfirmationModal.style.display = 'none';
    }

    window.confirmDelete = function() { 
    // L·∫•y gi√° tr·ªã t·ª´ tr∆∞·ªùng ·∫©n. S·ª≠ d·ª•ng .trim() ƒë·ªÉ lo·∫°i b·ªè kho·∫£ng tr·∫Øng
    const productIdString = document.getElementById('productToDeleteId').value.trim(); 
    
    // üí° C·∫£i ti·∫øn: Ch·ªâ chuy·ªÉn ƒë·ªïi sang s·ªë n·∫øu chu·ªói kh√¥ng r·ªóng
    const productId = productIdString ? parseInt(productIdString) : NaN;
    
    // console.log("ID s·∫£n ph·∫©m ƒëang ƒë∆∞·ª£c x√≥a l√†:", productId, typeof productId); 
    
    // Ki·ªÉm tra NaN (L·ªói NaN x·∫£y ra ·ªü ƒë√¢y)
    if (isNaN(productId) || productId === 0) { 
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m h·ª£p l·ªá ƒë·ªÉ x√≥a. Vui l√≤ng th·ª≠ l·∫°i.');
        closeDeleteConfirmation();
        return;
    }

    let products = JSON.parse(localStorage.getItem('products')) || [];
    
    // L·ªçc ra s·∫£n ph·∫©m c√≥ ID c·∫ßn x√≥a
    products = products.filter(p => p.id !== productId);
    
    localStorage.setItem('products', JSON.stringify(products));
    
    closeDeleteConfirmation();
    loadProducts(); 
    alert(`ƒê√£ x√≥a th√†nh c√¥ng s·∫£n ph·∫©m ID ${productId}.`);
}

    // --- CH·ª®C NƒÇNG C·∫¨P NH·∫¨T T·ªà L·ªÜ L·ª¢I NHU·∫¨N CHUNG ---

    // --- H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN SUBMIT (FIX CH·ª®C NƒÇNG) ---


function openProfitSettingsModal() {
    const margins = getProductMargins();
    renderProfitInputs(margins);
    document.getElementById('profitSettingsModal').style.display = 'block';
}
    window.closeProfitSettingsModal = function() {
        profitSettingsModal.style.display = 'none';
    }

    profitSettingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const newMargins = {};
        let isValid = true;

        document.querySelectorAll('#profitSettingsContainer input').forEach(input => {
        const type = input.dataset.type;
        const value = parseFloat(input.value);

        if (isNaN(value) || value < 0 || value > 100) {
            alert(`T·ªâ l·ªá l·ª£i nhu·∫≠n cho ${type} ph·∫£i n·∫±m trong kho·∫£ng 0-100.`);
            isValid = false;
        }
        newMargins[type] = value;
    });

        if (isValid) {
            saveProductMargins(newMargins);
            closeProfitSettingsModal();
            loadProducts(); 
        
        }
    });

    window.onclick = (event) => {
        if (event.target == addModal) {
            addModal.style.display = 'none';
        } else if (event.target == editModal) {
            editModal.style.display = 'none';
        } else if (event.target == productModal) {
            productModal.style.display = 'none';
        } else if (event.target == deleteConfirmationModal) {
            deleteConfirmationModal.style.display = 'none';
        } else if (event.target == profitSettingsModal) {
            profitSettingsModal.style.display = 'none';
        }
    };
    

    // --- H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN SUBMIT (FIX CH·ª®C NƒÇNG C·∫¨P NH·∫¨T) ---


// --- H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN SUBMIT (ƒê√£ s·ª≠a l·ªói alert) ---


// --- H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN SUBMIT (FIX L·ªñI ALERT) ---


if (profitSettingsForm) {
    profitSettingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Gi·ªØ l·∫°i ƒë·ªÉ ngƒÉn l·ªói l·∫∑p l·∫°i

        const newMargins = {};
        let isValid = true;
        
        const inputs = profitSettingsForm.querySelectorAll('input[data-category]');

        inputs.forEach(input => {
            const category = input.getAttribute('data-category'); 
            const valueTrimmed = input.value.trim();
            
            if (valueTrimmed !== '') {
                const value = parseFloat(valueTrimmed);
                
                if (!isNaN(value) && value >= 0 && value <= 100) {
                    newMargins[category] = value;
                } else {
                    alert(`L·ªói: T·ªâ l·ªá l·ª£i nhu·∫≠n cho [${category}] kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 100.`);
                    isValid = false;
                }
            }
        });

        if (isValid) {
            const oldMargins = getProductMargins(); 
            const updatedMargins = { ...oldMargins, ...newMargins }; 
            
            // 1. L∆ØU T·ªà L·ªÜ L·ª¢I NHU·∫¨N M·ªöI
            localStorage.setItem('profit_margins', JSON.stringify(updatedMargins));
            
            // 2. ‚≠êÔ∏è C·∫¨P NH·∫¨T GI√Å B√ÅN CHO T·∫§T C·∫¢ S·∫¢N PH·∫®M HI·ªÜN C√ì
            let products = JSON.parse(localStorage.getItem('products')) || [];
            
            const updatedProducts = products.map(p => {
                
                // Ch·ªâ √°p d·ª•ng profit m·ªõi cho c√°c s·∫£n ph·∫©m KH√îNG C√ì % ri√™ng
                if (p.profitPercent === undefined || p.profitPercent === null) {
                    
                    const typeForMarginLookup = p.type || 'M·∫∑c ƒë·ªãnh';
                    
                    // L·∫•y t·ªâ l·ªá l·ª£i nhu·∫≠n m·ªõi ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                    const newProfit = updatedMargins[typeForMarginLookup] !== undefined 
                                      ? updatedMargins[typeForMarginLookup] 
                                      : updatedMargins['M·∫∑c ƒë·ªãnh'];

                    // ‚≠êÔ∏è T√≠nh to√°n l·∫°i gi√° b√°n d·ª±a tr√™n t·ªâ l·ªá m·ªõi
                    const newSalePrice = calculateSalePrice(p.costPrice, newProfit);
                    
                    return {
                        ...p,
                        sellingPrice: newSalePrice, // L∆∞u gi√° b√°n m·ªõi
                        // T·ªâ l·ªá % trong localStorage V·∫™N gi·ªØ nguy√™n l√† undefined ƒë·ªÉ loadProducts() x·ª≠ l√Ω
                    };
                }
                return p;
            });

            // 3. L∆ØU DANH S√ÅCH S·∫¢N PH·∫®M ƒê√É C·∫¨P NH·∫¨T GI√Å B√ÅN
            localStorage.setItem('products', JSON.stringify(updatedProducts));
            
            // 4. HI·ªÇN TH·ªä TH√îNG B√ÅO V√Ä T·∫¢I L·∫†I
            alert('C·∫≠p nh·∫≠t t·ªâ l·ªá l·ª£i nhu·∫≠n v√† gi√° b√°n s·∫£n ph·∫©m th√†nh c√¥ng!'); 

            if (typeof closeProfitSettingsModal === 'function') {
                closeProfitSettingsModal();
            } else {
                 document.getElementById('profitSettingsModal').style.display = 'none';
            }
            
            // T·∫£i l·∫°i b·∫£ng ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi
            if (typeof loadProducts === 'function') {
                 loadProducts(); 
            }
        }
    });
}

// Gi·∫£ ƒë·ªãnh h√†m t√≠nh to√°n gi√° b√°n n√†y ƒë√£ t·ªìn t·∫°i trong code c·ªßa b·∫°n
function calculateSalePrice(costPrice, profitPercent) {
    if (profitPercent === undefined || profitPercent === null || isNaN(profitPercent)) {
        return costPrice;
    }
    return Math.round(costPrice * (1 + profitPercent / 100));
}

    // --- LOGIC CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU T·ª™ data.js ---

// CH√ö √ù: B·∫°n c·∫ßn ph·∫£i d√°n n·ªôi dung c·ªßa file data.js v√†o ƒë√¢y, 
// ho·∫∑c ƒë·∫£m b·∫£o n√≥ ƒë∆∞·ª£c link tr∆∞·ªõc script n√†y.
// V√≠ d·ª•: const productsFromDataJS = [ { name: "ƒê·ªìng h·ªì A", price: 750000, ... }, ... ];

// --- H√ÄM M·ªöI: CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU T·ª™ data.js ---
   // --- H√ÄM CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU T·ª™ data.js (ƒê√É C·∫¨P NH·∫¨T BRAND) ---
 // --- H√ÄM CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU T·ª™ data.js (ƒê√É C·∫¨P NH·∫¨T BRAND & SIZE) ---
   // --- H√ÄM CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU T·ª™ data.js (C·∫¨P NH·∫¨T C·ªòT K√çCH TH∆Ø·ªöC) ---
    // H√†m Chuy·ªÉn ƒë·ªïi v√† G√°n Lo·∫°i (Ph·ª• ki·ªán/ƒê·ªìng h·ªì)
// ƒê·∫∑t h√†m n√†y trong <script> c·ªßa ad_user.html
// H√†m Chuy·ªÉn ƒë·ªïi v√† G√°n Lo·∫°i (Ph·ª• ki·ªán/ƒê·ªìng h·ªì)
// H√†m Chuy·ªÉn ƒë·ªïi v√† G√°n Lo·∫°i (Ph·ª• ki·ªán/ƒê·ªìng h·ªì)
// =================================================================
    // LOGIC CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU S·∫¢N PH·∫®M (FINAL FIX)
    // V·ªã tr√≠: Thay th·∫ø logic chuy·ªÉn ƒë·ªïi c≈© ·ªü cu·ªëi file ad_user.html
    // =================================================================

    function transformProductsFromDataJS(productsFromDataJS) {
        if (!productsFromDataJS || productsFromDataJS.length === 0) {
            return [];
        }
        let currentId = 0;
        
        // ‚≠êÔ∏è DANH S√ÅCH TH∆Ø∆†NG HI·ªÜU ƒê·ªíNG H·ªí C·∫¶N PH√ÇN LO·∫†I
        const WATCH_BRANDS = ['Rolex', 'Citizen', 'Casio', 'Seiko', 'Rado'];

        return productsFromDataJS.map(p => {
            currentId++;
            
            const costPrice = Math.round((p.price * 0.7) / 1000) * 1000;
            
            let specificName = 'M·∫∑c ƒë·ªãnh'; // T√™n chi ti·∫øt ƒë·ªÉ hi·ªÉn th·ªã (Casio, D√¢y ƒëeo)
            let genericType = 'M·∫∑c ƒë·ªãnh'; // Lo·∫°i chung ƒë·ªÉ l·ªçc UI (ƒê·ªìng h·ªì, Ph·ª• ki·ªán)
            let productSize = 'N/A'; 
            
            const category = p.category ? p.category.toLowerCase() : '';

            // 1. Logic Ph√¢n lo·∫°i Ph·ª• ki·ªán
            if (category === 'phukien') {
                genericType = 'Ph·ª• ki·ªán'; // ‚ö†Ô∏è GI·ªÆ NGUY√äN cho b·ªô l·ªçc UI
                
                if (p.accessory === 'strap') {
                    specificName = 'D√¢y ƒëeo'; 
                } else if (p.accessory === 'case' || p.accessory === 'box') {
                    specificName = 'H·ªôp ƒë·ª±ng'; 
                } else if (p.accessory === 'protector' || p.accessory === 'film') {
                    specificName = 'C∆∞·ªùng l·ª±c';
                } else {
                    specificName = 'Ph·ª• ki·ªán'; 
                }
                productSize = 'N/A'; 

            // 2. Logic Ph√¢n lo·∫°i ƒê·ªìng h·ªì
            } else if (category === 'nam' || category === 'nu' || category === 'dongho' || category === 'watches' || category === 'capdoi' || category === 'couple') {
                
                genericType = 'ƒê·ªìng h·ªì'; // ‚ö†Ô∏è GI·ªÆ NGUY√äN cho b·ªô l·ªçc UI
                
                // L·∫•y t√™n th∆∞∆°ng hi·ªáu c·ª• th·ªÉ cho specificName
                let normalizedBrand = 'ƒê·ªìng h·ªì';
                if (p.brand) {
                    // Chuy·ªÉn ƒë·ªïi ch·ªØ c√°i ƒë·∫ßu ti√™n c·ªßa brand th√†nh ch·ªØ hoa (rolex -> Rolex)
                    normalizedBrand = p.brand.charAt(0).toUpperCase() + p.brand.slice(1).toLowerCase();
                }
                
                if (WATCH_BRANDS.includes(normalizedBrand)) {
                    specificName = normalizedBrand; // G√°n t√™n th∆∞∆°ng hi·ªáu (Casio, Seiko...)
                } else if (category === 'capdoi' || category === 'couple') {
                    specificName = 'C·∫∑p ƒë√¥i';
                } else {
                    specificName = 'ƒê·ªìng h·ªì'; // Fallback n·∫øu kh√¥ng kh·ªõp th∆∞∆°ng hi·ªáu
                }
                
                // G√°n K√≠ch th∆∞·ªõc (Size)
                if (category === 'nam') {
                    productSize = 'Nam'; 
                } else if (category === 'nu') {
                    productSize = 'N·ªØ'; 
                } else if (category === 'capdoi' || category === 'couple') {
                    productSize = 'C·∫∑p ƒë√¥i';
                } else {
                    productSize = 'N/A';
                }
            } 
            
            // Logic t√≠nh gi√° b√°n v√† l·ª£i nhu·∫≠n (gi·ªØ nguy√™n)
            const defaultProfitPercent = parseFloat(localStorage.getItem('profit_default')) || 35;
            const profitPercent = p.profitPercent ? parseFloat(p.profitPercent) : defaultProfitPercent;
            const salePrice = Math.round((costPrice / (1 - profitPercent / 100)) / 1000) * 1000;
            
            return {
                id: currentId,
                name: p.name || 'S·∫£n ph·∫©m kh√¥ng t√™n',
                type: genericType,      // üëà Lo·∫°i chung (Ph·ª• ki·ªán/ƒê·ªìng h·ªì) - Cho b·ªô l·ªçc UI
                categoryName: specificName, // üëà T√™n c·ª• th·ªÉ (D√¢y ƒëeo, Casio) - Cho hi·ªÉn th·ªã
                size: productSize, 
                costPrice: costPrice,
                salePrice: salePrice,
                profitPercent: profitPercent,
            };
        });
    }

    // ‚≠êÔ∏è Ch·∫°y h√†m chuy·ªÉn ƒë·ªïi v√† l∆∞u v√†o Local Storage
    // const allTransformedProducts = transformProductsFromDataJS(products);

    // if (allTransformedProducts.length > 0) {
    //     localStorage.setItem('products', JSON.stringify(allTransformedProducts));
    // } else {
    //     // Fallback
    //     const initialProducts = [
    //         { id: 1001, name: 'ƒê·ªìng h·ªì M·∫´u A', type: 'ƒê·ªìng h·ªì', categoryName: 'Casio', size: 'Nam', costPrice: 3000000, salePrice: 5000000, profitPercent: 40 },
    //         { id: 1002, name: 'D√¢y da cao c·∫•p', type: 'Ph·ª• ki·ªán', categoryName: 'D√¢y ƒëeo', size: 'N/A', costPrice: 150000, salePrice: 250000, profitPercent: 40 },
    //     ];
    //     localStorage.setItem('products', JSON.stringify(initialProducts));
    // }
    // ƒê·∫∑t h√†m n√†y trong <script> c·ªßa ad_user.html
// ƒê·∫∑t h√†m n√†y trong <script> c·ªßa ad_user.html
function renderProductTable() {
    // ƒê·∫£m b·∫£o b·∫°n c√≥ 1 ph·∫ßn t·ª≠ <tbody id="productTableBody"> trong HTML
    const tableBody = document.getElementById('productTableBody');
    if (!tableBody) {
        console.error("Kh√¥ng t√¨m th·∫•y tbody v·ªõi ID 'productTableBody'.");
        return;
    }
    tableBody.innerHTML = ''; 
    
    // ‚≠êÔ∏è L·∫•y T·∫§T C·∫¢ s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a t·ª´ localStorage
    const products = JSON.parse(localStorage.getItem('products')) || [];

    products.forEach(product => {
        const row = tableBody.insertRow();
        const isAccessory = product.type === 'Ph·ª• ki·ªán';

        row.insertCell().textContent = product.id; 
        
        // H√¨nh ·∫£nh (Code t∆∞∆°ng t·ª± b·∫°n ƒë√£ c√≥)
        const imgCell = row.insertCell();
        const img = document.createElement('img');
        img.src = product.image;
        img.alt = product.name;
        img.style.width = '50px';
        img.style.height = '50px';
        img.style.objectFit = 'cover';
        imgCell.appendChild(img);

        row.insertCell().textContent = product.name; 

        // ‚≠êÔ∏è KEY: Lo·∫°i s·∫£n ph·∫©m (Hi·ªÉn th·ªã Ph·ª• ki·ªán)
        row.insertCell().textContent = product.type; 

        // ‚≠êÔ∏è KEY: Th∆∞∆°ng hi·ªáu / Chi ti·∫øt Ph·ª• ki·ªán
        const detailCell = row.insertCell();
        if (isAccessory) {
            // Hi·ªÉn th·ªã Ch·∫•t li·ªáu v√† M√†u s·∫Øc cho Ph·ª• ki·ªán
            detailCell.innerHTML = `Lo·∫°i: <b>${product.accessoryType || 'N/A'}</b><br>Ch·∫•t li·ªáu: <b>${product.material || 'N/A'}</b>`;
        } else {
            // Hi·ªÉn th·ªã Th∆∞∆°ng hi·ªáu cho ƒê·ªìng h·ªì
            detailCell.textContent = product.brand || 'N/A';
        }

        // Gi√° v·ªën
        row.insertCell().textContent = product.costPrice ? Math.round(product.costPrice).toLocaleString('vi-VN') + '‚Ç´' : 'N/A';
        
        // Gi√° b√°n
        row.insertCell().textContent = product.sellingPrice ? product.sellingPrice.toLocaleString('vi-VN') + '‚Ç´' : 'N/A';

        // T·ªìn kho
        row.insertCell().textContent = product.stock || 0;

        // H√†nh ƒë·ªông
        const actionsCell = row.insertCell();
        actionsCell.innerHTML = `<button class="actions-btn btn-edit">S·ª≠a</button> <button class="actions-btn btn-delete">X√≥a</button>`;
    });
}

// ‚≠êÔ∏è ƒê·ª´ng qu√™n g·ªçi h√†m n√†y khi trang ƒë∆∞·ª£c t·∫£i xong
// V√≠ d·ª•: Sau khi tab "Qu·∫£n l√Ω B·∫£ng Gi√°" ƒë∆∞·ª£c k√≠ch ho·∫°t ho·∫∑c khi window.onload/DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    // G·ªçi h√†m transformProductsFromDataJS m·ªôt l·∫ßn ƒë·∫ßu ƒë·ªÉ l∆∞u v√†o localStorage
    // (Ph·∫ßn logic n√†y c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i trong file c·ªßa b·∫°n)
    // Sau ƒë√≥ g·ªçi h√†m renderProductTable ƒë·ªÉ hi·ªÉn th·ªã
    // Ch√∫ √Ω: N·∫øu b·∫°n c√≥ h·ªá th·ªëng tab, h√£y g·ªçi h√†m n√†y khi tab "Qu·∫£n l√Ω B·∫£ng Gi√°" ƒë∆∞·ª£c m·ªü.
    renderProductTable(); 
});

    // --- LOGIC KH·ªûI T·∫†O TRANG (ƒê·∫£m b·∫£o d·ªØ li·ªáu m·∫´u ƒë∆∞·ª£c t·∫°o n·∫øu Local Storage tr·ªëng) ---
    function initializeAdminPage() {
    // 1. Kh·ªüi t·∫°o d·ªØ li·ªáu ng∆∞·ªùi d√πng m·∫´u (gi·ªØ nguy√™n)
    if (!localStorage.getItem('users')) {
        const initialUsers = [
            { id: SUPERADMIN_ID, username: 'superadmin', email: 'sa@admin.com', password: '123456', role: 'admin', status: 'active' },
            { id: 1, username: 'admin01', email: 'admin@test.com', password: '123456', role: 'admin', status: 'active' },
            { id: 2, username: 'user01', email: 'user@test.com', password: '123456', role: 'user', status: 'active' }
        ];
        localStorage.setItem('users', JSON.stringify(initialUsers));
    }

    // 2. C·∫¨P NH·∫¨T: Kh·ªüi t·∫°o d·ªØ li·ªáu s·∫£n ph·∫©m t·ª´ data.js (n·∫øu ch∆∞a c√≥)
  // ... trong document.addEventListener('DOMContentLoaded', ...) ho·∫∑c logic kh·ªüi t·∫°o...

// 2. C·∫¨P NH·∫¨T: Kh·ªüi t·∫°o d·ªØ li·ªáu s·∫£n ph·∫©m t·ª´ data.js (n·∫øu ch∆∞a c√≥)
// ... trong document.addEventListener('DOMContentLoaded', ...) ho·∫∑c logic kh·ªüi t·∫°o...

// 2. C·∫¨P NH·∫¨T: Kh·ªüi t·∫°o d·ªØ li·ªáu s·∫£n ph·∫©m t·ª´ data.js (n·∫øu ch∆∞a c√≥)
if (localStorage.getItem('initial_data_loaded') !== 'true' || 
    !localStorage.getItem('products') || 
    JSON.parse(localStorage.getItem('products')).length === 0) 
{
    
    // ‚≠êÔ∏è 1. L·∫•y d·ªØ li·ªáu th√¥ t·ª´ 2 bi·∫øn ƒë·ªôc l·∫≠p (products v√† accessories)
    const rawWatches = typeof products !== 'undefined' ? products : []; 
    const rawAccessories = typeof accessories !== 'undefined' ? accessories : []; 
    
    // 2. Chuy·ªÉn ƒë·ªïi v√† g√°n ID + Lo·∫°i ri√™ng bi·ªát
    const transformedWatches = typeof transformItems !== 'undefined' ? transformItems(rawWatches, 'ƒê·ªìng h·ªì', 101) : [];
    const transformedAccessories = typeof transformItems !== 'undefined' ? transformItems(rawAccessories, 'Ph·ª• ki·ªán', 501) : [];

    // ‚≠êÔ∏è 3. Gh√©p 2 m·∫£ng l·∫°i th√†nh m·ªôt
    const allTransformedProducts = [...transformedWatches, ...transformedAccessories];

    if (allTransformedProducts.length > 0) {
         localStorage.setItem('products', JSON.stringify(allTransformedProducts));
         // ‚≠êÔ∏è ƒê·∫∂T C·ªú: ƒê√°nh d·∫•u r·∫±ng d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng l·∫ßn ƒë·∫ßu.
         localStorage.setItem('initial_data_loaded', 'true'); 
         console.log(`ƒê√£ t·∫£i ${allTransformedProducts.length} s·∫£n ph·∫©m (ƒê·ªìng h·ªì & Ph·ª• ki·ªán) t·ª´ data.js v√†o Local Storage.`);
    } else {
         // N·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu, t·∫°o d·ªØ li·ªáu m·∫´u
         const initialProducts = [
            { id: 101, name: 'ƒê·ªìng h·ªì M·∫´u A', type: 'ƒê·ªìng h·ªì', categoryName: 'M·∫´u', costPrice: 3000000, sellingPrice: 5000000, stock: 10, size: 'Nam' },
            { id: 501, name: 'D√¢y da cao c·∫•p', type: 'Ph·ª• ki·ªán', categoryName: 'D√¢y ƒëeo', costPrice: 150000, sellingPrice: 250000, stock: 20, size: 'N/A' },
         ];
         localStorage.setItem('products', JSON.stringify(initialProducts));
         localStorage.setItem('initial_data_loaded', 'true');
         console.log('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ data.js, t·∫°o d·ªØ li·ªáu m·∫´u.');
    }
}

// ‚≠êÔ∏è ƒê·ª´ng qu√™n g·ªçi h√†m render b·∫£ng sau khi ƒë√£ kh·ªüi t·∫°o xong
renderProductTable();

    // 3. M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã tab ƒë·∫ßu ti√™n (gi·ªØ nguy√™n)
    showTab('qluser'); 
}

    // <--- FIX C·ªêT L√ïI: ƒê·∫£m b·∫£o h√†m kh·ªüi t·∫°o ch·∫°y khi trang load
    window.onload = initializeAdminPage;

    </script>
    </body>
    </html>